# 捲動體驗改善計畫

## 問題描述

使用者回報區域捲動「怪怪的」，雖然能用但體驗與原生兩指捲動有明顯落差。
關鍵觀察：**即使用兩指捲動很勉強，體驗仍然比目前的單指區域捲動好。**

## 日誌分析結果

### bottomEdge（水平捲動）拒絕率極高

| 結果 | 次數 | 比例 |
|------|------|------|
| 啟動成功 | ~6 | ~25% |
| 方向不符被拒 | ~17 | ~65% |
| 逾時被拒 | ~4 | ~15% |

### rightEdge（垂直捲動）狀況較好

| 結果 | 次數 | 比例 |
|------|------|------|
| 啟動成功 | ~13 | ~70% |
| 被拒 | ~6 | ~30% |

## 根因分析

經由兩個獨立分析角度（意圖偵測 / 捲動物理）交叉比對，歸納出以下根因：

### 1. 缺少 Scroll Phase 元資料（最關鍵）

原生兩指捲動事件帶有完整的 phase 生命週期：

```
scrollPhase:    began → changed → ended
momentumPhase:  began → changed → ended
```

我們的 CGEvent 完全沒有設定這些欄位（field 99 與 field 123），導致：
- App 把事件當作舊式滑鼠滾輪處理（離散、階梯式）
- 橡皮筋回彈效果失效或異常
- App 不知道何時該啟動/停止慣性動畫
- 慣性結束後 App 可能卡在「捲動中」狀態

### 2. 激活延遲過高（33-135ms）

原生捲動延遲 ≈ 0ms。我們需要 4-8 幀才能判定意圖：
- **空白期**：手指在動但畫面沒反應（33-135ms）
- **跳躍感**：激活成功時緩衝的 delta 一次刷出，造成突然位移
- **不確定性**：使用者不知道捲動是否會被接受

### 3. bottomEdge 方向判定不公平

觸控板實體比例約 1.6:1，但歸一化座標是 1:1。
bottomEdge 需要 X 軸主導（`totalDx / total >= 0.55`），但：
- Y 方向噪音在歸一化空間中被放大（物理高度較短）
- 手指從中間區域接近底部邊緣時，初始移動含有大量 Y 分量
- 底部區域靠近手腕，初始觸碰角度偏斜

### 4. 慣性感覺「機械」而非「物理」

- 摩擦力用階梯函數（速度 119 vs 121 的摩擦係數突變：0.93 vs 0.95）
- 初始慣性速度倍率太高（`velocity * multiplier * 50`），內容「飛過去」
- 沒有送出慣性結束事件

### 5. 激活期間游標仍在移動

在 ACTIVATING 判定期間（33-135ms），系統捲動事件未被攔截，
使用者看到游標先移動一段距離，然後突然停住開始捲動，體驗突兀。

## 改善計畫

### P0: 加入 scrollPhase / momentumPhase 生命週期

**改動內容：**
- `TrackpadZoneScroller.postScrollEvent` 加入 scroll phase 狀態追蹤
- 第一個捲動事件：`scrollPhase = began (1)`
- 後續事件：`scrollPhase = changed (2)`
- 手指離開時：`scrollPhase = ended (4)`, delta = 0
- `InertiaScroller` 加入 momentum phase 標註
- 第一個慣性事件：`momentumPhase = began (1)`
- 後續事件：`momentumPhase = changed (2)`
- 最後一個事件：`momentumPhase = ended (4)`, delta = 0

**預期效果：** 所有 App 正確辨識捲動生命週期，啟用平滑捲動、橡皮筋回彈、慣性動畫。

### P1: 降低激活延遲 + 改善 bottomEdge 判定

**改動內容：**
- `activationFramesNeeded` 從 4 降為 2
- 方向一致性判定加入長寬比補償（bottomEdge/topEdge 的 X 位移乘以 1.6）
- 或改用逐幀主軸投票制（多數幀的主軸方向正確即通過）

**預期效果：** 延遲從 33-135ms 降至 ~20-50ms，bottomEdge 成功率從 25% 提升至 60-70%。

### P2: 緩衝 delta 漸入

**改動內容：**
- 激活成功時，緩衝的 delta 用遞增權重送出：第 1 幀 25%、第 2 幀 50%、...
- 取代目前一次全部刷出的做法

**預期效果：** 消除激活瞬間的跳躍感，捲動起始更平滑。

### P3: 慣性改為連續衰減

**改動內容：**
- 摩擦力從階梯函數改為連續指數衰減 `v *= pow(0.998, dtMs)`
- 降低初始慣性速度倍率（`* 50` → 更低的值）
- 慣性結束時送出 `momentumPhase = ended` 事件（與 P0 連動）

**預期效果：** 慣性從「機械煞車」變成「自然滑行」，內容不再飛過頭。

### P4: 激活期間抑制系統事件

**改動內容：**
- 進入 ACTIVATING 狀態時就設定 `isActivelyScrollingInZone = true`
- 若激活被拒，重設為 `false` 讓游標恢復

**預期效果：** 消除「游標先動再捲」的突兀過渡。

## 實作狀態

- [ ] P0: scrollPhase / momentumPhase 生命週期
- [ ] P1: 降低激活延遲 + bottomEdge 判定改善
- [ ] P2: 緩衝 delta 漸入
- [ ] P3: 慣性連續衰減
- [ ] P4: 激活期間事件抑制
